# =============================================================
# TELEPHONY CAPABILITIES (CORE LOGIC)
# =============================================================  
name: sentiric

x-common-settings: &common-settings
  dns:
    - 10.88.5.1 # ${DISCOVERY_SERVICE_IPV4_ADDRESS:-10.88.5.1}
    - 8.8.8.8
    - 1.1.1.1
  dns_search:
    - service.sentiric.cloud
  restart: always

networks:
  sentiric-net:
    external: true

volumes:
  infra-minio-data:


services:

  # üè™ MINIO SERVICE (Object Storage)
  minio:

    <<: *common-settings

    image: ghcr.io/sentiric/sentiric-minio:latest

    environment:
      - MINIO_FS_STAT_CACHE_LIMIT=0
      - MINIO_ROOT_USER=sentiric
      - MINIO_ROOT_PASSWORD=sentiric-secret-key
    volumes:
      - "../sentiric-certificates:/sentiric-certificates:ro"
      - infra_minio_data:/data

    container_name: minio

    networks:
      sentiric-net:


    ports:
      - "9000:9000"
      - "9001:9001"

    command: server /data --console-address ":9001"

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/ready" ]

  # üéôÔ∏è MEDIA SERVICE
  media-service:
    <<: *common-settings
    image: ghcr.io/sentiric/sentiric-media-service:latest

    environment:
      - ENV=development
      - RUST_LOG=info,sentiric_media_service=info

      - MEDIA_SERVICE_GRPC_PORT=13031
      - MEDIA_SERVICE_METRICS_PORT=13032

      - RTP_SERVICE_LISTEN_ADDRESS=0.0.0.0
      - RTP_SERVICE_PORT_MIN=10000
      - RTP_SERVICE_PORT_MAX=10010
      - RTP_SERVICE_PORT_QUARANTINE_SECONDS=2
      - RTP_SESSION_INACTIVITY_TIMEOUT_SECONDS=10
      - RTP_COMMAND_CHANNEL_BUFFER=32

      - LIVE_AUDIO_STREAM_BUFFER=64

      - BUCKET_ENDPOINT_URL=http://minio:9000
      - BUCKET_REGION=auto
      - BUCKET_ACCESS_KEY_ID=sentiric
      - BUCKET_SECRET_ACCESS_KEY=sentiric-secret-key
      - BUCKET_NAME=sentiric

      - RABBITMQ_URL=amqp://sentiric:sentiric_pass@rabbitmq:5672/%2f
      - ASSETS_BASE_PATH=/sentiric-assets

      - MEDIA_SERVICE_CERT_PATH=/sentiric-certificates/certs/media-service-chain.crt
      - MEDIA_SERVICE_KEY_PATH=/sentiric-certificates/certs/media-service.key
      - GRPC_TLS_CA_PATH=/sentiric-certificates/certs/ca.crt

    volumes:
      - "../sentiric-config:/sentiric-config:ro"
      - "../sentiric-certificates:/sentiric-certificates:ro"
      - "../sentiric-assets:/sentiric-assets:ro"

    container_name: media-service

    networks:
      sentiric-net:


    ports:
      - "13031:13031"
      - "13032:13032"
      # RTP port aralƒ±ƒüƒ±nƒ± Host makineye a√ßƒ±yoruz.[Daha Fazla port aralƒ±ƒüƒ±na gerek yok]
      - "10000-10010:10000-10010/udp"

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:13032/healthz" ]

  # üéõÔ∏è TELEPHONY ACTION SERVICE (Orchestration Layer)
  telephony-action-service:
    <<: *common-settings
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/sentiric/sentiric-telephony-action-service:latest

    environment:
      # --- Identity ---    
      - ENV=development
      - LOG_LEVEL=info

      # --- Network (Layer: 131xx) ---
      - TELEPHONY_ACTION_SERVICE_HTTP_PORT=13050
      - TELEPHONY_ACTION_SERVICE_GRPC_PORT=13051
      - TELEPHONY_ACTION_SERVICE_METRICS_PORT=13052

      # --- Security (mTLS) ---
      - GRPC_TLS_CA_PATH=/sentiric-certificates/certs/ca.crt
      - TELEPHONY_ACTION_SERVICE_CERT_PATH=/sentiric-certificates/certs/telephony-action-service-chain.crt
      - TELEPHONY_ACTION_SERVICE_KEY_PATH=/sentiric-certificates/certs/telephony-action-service.key

      # --- Target ---
      - MEDIA_SERVICE_TARGET_GRPC_URL=https://media-service:13031
      - TTS_GATEWAY_TARGET_GRPC_URL=https://tts-gateway-service:14011
      - STT_GATEWAY_TARGET_GRPC_URL=https://stt-gateway-service:15021
      - DIALOG_SERVICE_TARGET_GRPC_URL=https://dialog-service:12061
      # Bu servis kullanƒ±mdan kaldƒ±rƒ±ldƒ±?
      - SIP_SIGNALING_TARGET_GRPC_URL=https://sip-signaling-service:13021

    volumes:
      - "../sentiric-certificates:/sentiric-certificates:ro"

    container_name: telephony-action-service

    networks:
      sentiric-net:


    ports:
      - "13050:13050"
      - "13051:13051"
      - "13052:13052"

    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "13051" ]
